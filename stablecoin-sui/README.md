# stablecoin-sui

## Devnet/Testnet Faucet (USDC) â€” This fork

This fork adds a simple faucet module under `packages/stablecoin/sources/faucet.move` that is intended for devnet/testnet only. It is generic over the coin type `T` and integrates with `stablecoin::treasury::Treasury<T>` (which wraps `0x2::coin::TreasuryCap<T>`). On devnet/testnet it uses a devnet-only mint path.

The flow below shows USDC on devnet; adapt as needed for testnet.

### 1) Automated Build & Deploy using build_all.py

The `build_all.py` script automates the entire build, publish, and deployment process:

```bash
# Run the comprehensive build and deployment script
python3 build_all.py
```

This script will:

1. Build and publish all packages in the correct order:
   - `sui_extensions`
   - `stablecoin`
   - `usdc`
2. Create the Treasury object
3. Create the Faucet object
4. Verify USDC data types
5. Save all contract IDs to `json/contract_ids.env`

The script will prompt you for confirmation before creating the Treasury and Faucet objects. Press 'y' to proceed.

After completion, all environment variables will be automatically saved to `json/contract_ids.env`.

#### Manual Alternative

If you prefer to run the steps manually, you can follow the original process below. However, using `build_all.py` is recommended as it handles all dependencies and type matching automatically.

### 2) Request tokens from the faucet (testing/usage)

> **Note**: The following commands assume you have already run `build_all.py` and sourced the environment variables with `source json/contract_ids.env`. These commands are for testing and manual usage only.

Amounts are in atomic units (USDC has 6 decimals). For 50 USDC, use `50000000`.

```bash
# Sender mints to self
sui client call \
  --package "$STABLECOIN_PACKAGE" \
  --module faucet \
  --function request \
  --type-args "$USDC_PACKAGE::usdc::USDC" \
  --args "$FAUCET_ID" "$FAUCET_ID" 50000000 "$CLOCK" \
  --gas-budget 10000000

# Or mint to a specific recipient
sui client call \
  --package "$STABLECOIN_PACKAGE" \
  --module faucet \
  --function request \
  --type-args "$USDC_PACKAGE::usdc::USDC" \
  --args "$FAUCET_ID" <RECIPIENT_ADDRESS> 50000000 "$CLOCK" \
  --gas-budget 10000000
```

### 3) Environment Configuration

For the backend faucet service, update your `.env` file with the values automatically generated by `build_all.py`:

```bash
# Source the contract IDs from the automated build
source json/contract_ids.env

# backend/.env file content:
cat > backend/.env << EOF
PORT=8787
FULLNODE_URL=https://fullnode.devnet.sui.io:443
CLOCK=0x6
FAUCET_ID=$FAUCET_ID

# Stablecoin faucet (generic over USDC)
STABLECOIN_PACKAGE=$STABLECOIN_PACKAGE
USDC_PACKAGE=$USDC_PACKAGE
TREASURY=$TREASURY
EOF
```

Alternatively, you can copy the values directly from `json/contract_ids.env` after running `build_all.py`.

### 4) Frontend Configuration

Update your frontend config to use the local USDC by sourcing the values from `build_all.py`:

```bash
# Source the contract IDs from the automated build
source json/contract_ids.env

# Extract protocol package ID (assuming you published aquilo_protocol)
AQUILO_PACKAGE=$(jq -r '.objectChanges[] | select(.type=="published") | .packageId' json/aquilo_protocol.out.json)

# Extract market factory ID from protocol publication
MARKET_FACTORY_ID=$(jq -r '.objectChanges[] | select(.type=="created" and (.objectType|test("::market_factory::MarketFactory"))) | .objectId' json/aquilo_protocol.out.json)

echo "Frontend config values:"
echo "packageId: $AQUILO_PACKAGE"
echo "marketFactoryId: $MARKET_FACTORY_ID"
echo "usdc: $USDC_PACKAGE::usdc::USDC"

# Update frontend/src/config.ts with these values
```

Example config.ts content:

```typescript
// config.ts
export const networkConfig: Record<string, NetworkConfig> = {
  "sui:devnet": {
    packageId: "$AQUILO_PACKAGE",
    marketFactoryId: "$MARKET_FACTORY_ID",
    usdc: "$USDC_PACKAGE::usdc::USDC",
  },
  // ... other networks
};
```

### 5) Summary

âœ… **TypeMismatch Resolved**: All components now use the same USDC type from your published local packages.

âœ… **Automated Deployment**: The `build_all.py` script handles the entire build, publish, and deployment process automatically.

ðŸ”„ **Next Steps**:

1. Run `python3 build_all.py` to build, publish, and deploy all contracts
2. Source the environment variables: `source json/contract_ids.env`
3. Update your backend `.env` file with the generated values
4. Test minting USDC tokens using the faucet

Restart backend and POST to `/api/request` with `recipient` and `amount` (atomic units).

> Note: This faucet and the devnet mint path are for devnet/testnet only. Do not use on mainnet.
